<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Route 1 ‚Äì City Heritage to Telok Ayer</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      margin: 0;
      font-family: Poppins, sans-serif;
      background: #f0f8ff;
      text-align: center;
    }

    .back-link {
      display: inline-block;
      margin: 10px;
      padding: 8px 14px;
      background: #0077b6;
      color: #fff;
      border-radius: 6px;
      text-decoration: none;
      font-weight: 500;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .back-link:hover {
      background-color: #005f87;
    }

    h2 {
      margin: 4px 12px 2px;
      font-size: 1.2em;
    }

    #map {
      height: 55vh;
      width: 95%;
      border-radius: 12px;
      margin: 5px auto;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    #remark-box {
      font-size: 1em;
      margin-top: 8px;
      padding: 10px;
      background: #fff8dc;
      border-radius: 8px;
      width: 90%;
      margin-left: auto;
      margin-right: auto;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      min-height: 2.4em;
    }

    .controls {
      margin-top: 10px;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 6px;
    }

    button {
      padding: 8px 18px;
      font-size: 0.95em;
      margin: 5px 3px;
      border: none;
      border-radius: 6px;
      background-color: #0077b6;
      color: white;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    button:hover {
      background-color: #005f87;
    }
    button:disabled {
      background-color: #a0c4ff;
      cursor: not-allowed;
    }

    .toggle-wrapper {
      margin-top: 6px;
      font-size: 0.9em;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 6px;
    }
    .toggle-wrapper input[type="checkbox"] {
      transform: scale(1.1);
      cursor: pointer;
    }

    /* LEGEND */
    #legend-box {
      position: fixed;
      top: 20px;
      right: 15px;
      background: #ffffffcc;
      padding: 10px 12px;
      border-radius: 8px;
      font-size: 0.85em;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      text-align: left;
      line-height: 1.4em;
      z-index: 9999;
    }

    .light {
      display: inline-block;
      width: 11px;
      height: 11px;
      margin-right: 6px;
      border-radius: 50%;
    }

    .light.red { background: red; }
    .light.amber { background: orange; }
    .light.green { background: green; }

    /* PROGRESS BAR */
    #progress-container {
      width: 90%;
      height: 10px;
      background: #e0e0e0;
      border-radius: 6px;
      margin: 15px auto 5px;
      overflow: hidden;
    }

    #progress-bar {
      width: 0%;
      height: 100%;
      background: #0077b6;
      transition: width 0.2s linear;
    }

    #progress-text {
      font-size: 0.9em;
      color: #333;
      margin-bottom: 10px;
    }

    #timer-box {
      margin-top: 8px;
      font-size: 1.1em;
      font-weight: 600;
      color: #023e8a;
    }

    /* SPEED CONTROL */
    #speed-control {
      margin-top: 8px;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      font-size: 0.9em;
    }
    #speedSlider {
      width: 160px;
    }
    #speed-label {
      font-weight: 600;
      color: #024b84;
    }

    /* LOWER PANELS LAYOUT */
    .bottom-panels {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      width: 95%;
      margin: 10px auto 20px;
    }

    #narration-panel, #checkpoints-panel {
      background: #ffffff;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      padding: 10px 12px;
      font-size: 0.9em;
      text-align: left;
      flex: 1 1 260px;
      max-width: 360px;
    }

    #narration-panel h3,
    #checkpoints-panel h3 {
      margin: 0 0 6px;
      font-size: 1em;
      color: #023e8a;
    }

    #current-narration,
    #next-narration {
      margin: 3px 0;
    }

    #checkpoints-panel ul {
      list-style: none;
      padding-left: 0;
      margin: 4px 0 0;
      max-height: 180px;
      overflow-y: auto;
    }

    #checkpoints-panel li {
      margin-bottom: 4px;
      font-size: 0.88em;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .checkpoint-icon {
      font-size: 0.9em;
      width: 18px;
      text-align: center;
    }

    .checkpoint.done {
      color: green;
      text-decoration: line-through;
    }

    /* MINI-MAP */
    #mini-map-container {
      position: fixed;
      bottom: 15px;
      right: 15px;
      width: 180px;
      height: 130px;
      background: #ffffffcc;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
      z-index: 9998;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    #mini-map-title {
      font-size: 0.8em;
      padding: 4px 6px;
      background: #0077b6;
      color: #fff;
      text-align: left;
    }

    #mini-map {
      flex: 1;
    }

    @media (min-width: 768px) {
      h2 { font-size: 1.5em; }
      #map { height: 60vh; width: 90%; }
      #remark-box { font-size: 1.05em; width: 80%; }
    }
  </style>
</head>
<body>
  <a href="index.html" class="back-link">‚¨Ö Back to Home</a>

  <h2>üöó Singapore Route Tracker ‚Äì Coleman St to Thian Hock Keng</h2>

  <div id="map"></div>

  <div id="remark-box">Start of the route...</div>

  <!-- TRAFFIC LIGHT LEGEND -->
  <div id="legend-box">
    <strong>Traffic Lights</strong><br>
    <span class="light red"></span> Red ‚Äì Stop<br>
    <span class="light amber"></span> Amber ‚Äì Prepare to Stop<br>
    <span class="light green"></span> Green ‚Äì Moving
  </div>

  <!-- PROGRESS BAR -->
  <div id="progress-container">
    <div id="progress-bar"></div>
  </div>
  <div id="progress-text">Progress: 0%</div>

   <!-- TIMER -->
  <div id="timer-box">‚è± 00:00</div>

  <!-- SPEED CONTROL -->
  <div id="speed-control">
    <span>Speed:</span>
    <input type="range" id="speedSlider" min="1" max="3" step="1" value="2" />
    <span id="speed-label">Normal</span>
  </div>

  <!-- MAIN CONTROLS -->
  <div class="controls">
    <button id="startBtn">‚ñ∂ Start</button>
    <button id="stopBtn" disabled>‚èπ Stop</button>
    <button id="prevBtn">‚è™ Previous</button>
    <button id="resetBtn">üîÅ Reset</button>
  </div>

  <div class="toggle-wrapper">
    <label for="voiceToggle">üîä Voice narration</label>
    <input type="checkbox" id="voiceToggle" checked />
  </div>

  <!-- Auto narration + checkpoints panels -->
  <div class="bottom-panels">
    <div id="narration-panel">
      <h3>Auto-Narration</h3>
      <div id="current-narration"><strong>Current:</strong> None yet ‚Äî starting soon.</div>
      <div id="next-narration"><strong>Next:</strong> Central Fire Station</div>
    </div>

    <div id="checkpoints-panel">
      <h3>Milestone Checkpoints</h3>
      <ul id="checkpoint-list">
        <!-- Populated by JS -->
      </ul>
    </div>
  </div>

  <!-- MINI MAP OVERVIEW -->
  <div id="mini-map-container">
    <div id="mini-map-title">Mini Overview</div>
    <div id="mini-map"></div>
  </div>

  <!-- Single audio player reused for all narrations -->
  <audio id="narrationPlayer"></audio>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    const remarkBox = document.getElementById("remark-box");
    const progressBar = document.getElementById("progress-bar");
    const progressText = document.getElementById("progress-text");
    const speedSlider = document.getElementById("speedSlider");
    const speedLabel = document.getElementById("speed-label");
    const narrationAudio = document.getElementById("narrationPlayer");
    const voiceToggle = document.getElementById("voiceToggle");
    const currentNarrationEl = document.getElementById("current-narration");
    const nextNarrationEl = document.getElementById("next-narration");
    const checkpointList = document.getElementById("checkpoint-list");

    // -----------------------------
    // MAIN MAP INITIALISATION
    // -----------------------------
    const map = L.map('map').setView([1.290270, 103.851959], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    // -----------------------------
    // ROUTE COORDINATES
    // -----------------------------
    const route = [
      [1.2928, 103.8489], // Coleman St 1
      [1.2927, 103.8491], // Coleman St 2
      [1.2925, 103.8495], // Coleman St 3 / Hill St 1
      [1.2932, 103.8498], // Hill St 3.5
      [1.2946, 103.8506], // Victoria St 1
      [1.2955, 103.8513], // Victoria St 2
      [1.2957, 103.8515], // Victoria St 
      [1.295700932944538, 103.85159499458777], // CHIJMES
      [1.2962, 103.8520], // Victoria St 4
      [1.2968, 103.8526], // Victoria St 5
      [1.2978, 103.8533], // Victoria St 6
      [1.2985, 103.8540], // Victoria St 9
      [1.2984, 103.8542], // Victoria St 12 / Middle Rd 1
      [1.2980, 103.8547], // Middle Rd 4
      [1.2978, 103.8549], // Middle Rd 5
      [1.2976, 103.8550], // Middle Rd 7
      [1.2974, 103.8548], // Middle Rd 8 / North Bridge Rd 1
      [1.2967, 103.8543], // North Bridge Rd 2
      [1.2965, 103.8541], // North Bridge Rd 3
      [1.2963, 103.8539], // North Bridge Rd 4
      [1.2959, 103.8537], // North Bridge Rd 5
      [1.2957, 103.8535], // North Bridge Rd 6
      [1.2952, 103.8532], // North Bridge Rd 7
      [1.2946, 103.8527], // North Bridge Rd 8
      [1.2937, 103.8521], // North Bridge Rd 9
      [1.2930, 103.8516], // North Bridge Rd 10
      [1.2923, 103.8512], // North Bridge Rd 11
      [1.2917, 103.8509], // North Bridge Rd 12
      [1.2913, 103.8507], // North Bridge Rd 13
      [1.2907, 103.8503], // North Bridge Rd 14
      [1.2903, 103.8500], // North Bridge Rd 15
      [1.2901, 103.8500], // North Bridge Rd 16
      [1.2898, 103.8504], // Parliament Hse 1
      [1.2895, 103.8507], // Parliament Hse 2
      [1.2892, 103.8514], // Parliament Hse 3
      [1.2895, 103.8516], // Saint Andrews Rd 1
      [1.2901, 103.8519], // Saint Andrews Rd 2
      [1.2909, 103.8524], // Saint Andrews Rd 3
      [1.2924, 103.8533], // Saint Andrews Rd 4
    
      [1.2927, 103.8539], // Turning to Beach Rd
      [1.2930, 103.8542], // Beach Rd 1

      [1.2972, 103.8568], // Beach Rd 8
      [1.2978, 103.8574], // Beach Rd 9
      [1.2983, 103.8579], // Beach Rd 10 / Rochor Rd 1
      [1.2986, 103.8576], // Rochor Rd 2
      [1.2989, 103.8574], // Rochor Rd 3
      [1.2998, 103.8566], // Rochor Rd 4 / North Bridge Rd 1
      [1.2991, 103.8561], // North Bridge Rd 2
      [1.2987, 103.8558], // North Bridge Rd 3
      [1.2978, 103.8551], // North Bridge Rd 4
      [1.2969, 103.8544], // North Bridge Rd 5
      [1.2966, 103.8542], // North Bridge Rd 6
      [1.2953, 103.8532], // North Bridge Rd 7
      [1.2937, 103.8522], // North Bridge Rd 8
      [1.2929, 103.8516], // North Bridge Rd 9
      [1.2919, 103.8510], // North Bridge Rd 10
      [1.2903, 103.8501], // North Bridge Rd 11
      [1.2895, 103.8496], // North Bridge Rd 12 / Elgin Bridge
      [1.2893, 103.8494], // Elgin Bridge 2
      [1.2889, 103.8491], // Elgin Bridge 3
      [1.2881, 103.8487], // Elgin Bridge 4 / South Bridge Rd 1
      [1.2850, 103.8468], // South Bridge Rd 2
      [1.2838, 103.8461], // South Bridge Rd 3
      [1.2827, 103.8455], // South Bridge Rd 4
      [1.2818, 103.8449], // South Bridge Rd 5
      [1.2813, 103.8447], // South Bridge Rd 6 / Erskine Rd 1
      [1.2809, 103.8451], // Erskine Rd 2
      [1.2804, 103.8453], // Erskine Rd 3
      [1.2802, 103.8453], // Erskine Rd 4 / Kadayanallur Rd 1
      [1.2801, 103.8452], // Kadayanallur Rd 2
      [1.2798, 103.8448], // Kadayanallur Rd 3
      [1.2797, 103.8446], // Kadayanallur Rd 4 / Maxwell Rd 1
      [1.2793, 103.8450], // Maxwell Rd 2
      [1.2783, 103.8458], // Maxwell Rd 3
      [1.2778, 103.8462], // Maxwell Rd 4
      [1.2776, 103.8465], // Maxwell Rd 5 / Cecil St 1
      [1.2775, 103.8470], // Cecil St 2
      [1.2783, 103.8475], // Cecil St 3
      [1.2791, 103.8479], // Cecil St 4
      [1.2797, 103.8483], // Cecil St 5
      [1.2808, 103.8490], // Cecil St 6
      [1.2816, 103.8494], // Cecil St 7
      [1.2821, 103.8486], // Cecil St 8 / Cross St 1
      [1.2821, 103.8484], // Cross St 2 / Telok Ayer St 1
      [1.2806, 103.8475], // Telok Ayer St 2 / End at Thian Hock Keng Temple
    ];

    const polyline = L.polyline(route, { color: 'blue', weight: 5 }).addTo(map);
    map.fitBounds(polyline.getBounds());

    // -----------------------------
    // LANDMARKS
    // -----------------------------
    const landmarks = [
      {
        name: "Central Fire Station",
        coords: [1.2922, 103.8492],
        remark: "On your right is the Central Fire Station, one of Singapore‚Äôs oldest fire stations with its distinctive red-and-white fa√ßade.",
        audioId: "central_fire_station"
      },
      {
        name: "Armenian Church",
        coords: [1.2930, 103.8495],
        remark: "On your left is the Armenian Church, the oldest Christian church in Singapore, completed in 1835.",
        audioId: "armenian_church"
      },
      {
        name: "Singapore Chinese Chamber of Commerce",
        coords: [1.2933, 103.8501],
        remark: "To your right, the Singapore Chinese Chamber of Commerce and Industry, an important voice for the local Chinese business community.",
        audioId: "sccci"
      },
      {
        name: "Kempinski Hotel",
        coords: [1.2941, 103.8508],
        remark: "On the right is The Capitol Kempinski Hotel, housed in beautifully restored historic buildings.",
        audioId: "kempinski"
      },
      {
        name: "Singapore Management University (SMU)",
        coords: [1.2950, 103.8506],
        remark: "On your left is Singapore Management University, a city campus integrated directly into the civic district.",
        audioId: "smu"
      },
      {
        name: "Cathedral of the Good Shepherd",
        coords: [1.2959, 103.8513],
        remark: "To your left, the Cathedral of the Good Shepherd, the oldest Roman Catholic church in Singapore. On the right you can see CHIJMES.",
        audioId: "good_shepherd"
      },
      {
        name: "CHIJMES",
        coords: [1.29534446176375, 103.85191362475821],
        remark: "On your right is CHIJMES, a former convent school turned lifestyle and dining complex, with a beautiful Gothic-style chapel.",
        audioId: "chijmes"
      },
      {
        name: "Bras Basah Complex",
        coords: [1.2966633620576473, 103.8537043934213],
        remark: "On your right is Bras Basah Complex, once famous as a haven for second-hand bookstores and stationery shops.",
        audioId: "bras_basah"
      },
      {
        name: "St Joseph's Church",
        coords: [1.2984351315280636, 103.85313494735979],
        remark: "On your left stands St Joseph‚Äôs Church, a Catholic church with strong Eurasian heritage.",
        audioId: "st_joseph"
      },
      {
        name: "National Design Centre",
        coords: [1.2984, 103.8536],
        remark: "Ahead on the left is the National Design Centre, a hub for design exhibitions and creative events. On the right is the National Library.",
        audioId: "national_design_centre"
      },
      {
        name: "National Library of Singapore",
        coords: [1.2976, 103.8542],
        remark: "On your right is the National Library of Singapore, a modern landmark for readers and researchers.",
        audioId: "national_library"
      },
      {
        name: "Raffles Hotel",
        coords: [1.2950, 103.8534],
        remark: "On your left is the iconic Raffles Hotel, opened in 1887 and famous for the Singapore Sling cocktail.",
        audioId: "raffles_hotel"
      },
      {
        name: "St Andrew's Cathedral",
        coords: [1.2924, 103.8522],
        remark: "On your left is St Andrew‚Äôs Cathedral, a striking white Anglican cathedral with a long history in Singapore.",
        audioId: "st_andrew"
      },
      {
        name: "Supreme Court",
        coords: [1.2905, 103.8508],
        remark: "On your left is the new Supreme Court building, linked architecturally to the former City Hall and Old Supreme Court nearby.",
        audioId: "supreme_court"
      },
      {
        name: "National Gallery Singapore",
        coords: [1.2902, 103.8516],
        remark: "On your left, National Gallery Singapore, housing the world‚Äôs largest public collection of modern Southeast Asian art. On the right is the Padang.",
        audioId: "national_gallery"
      },
      {
        name: "The Padang",
        coords: [1.2907, 103.8528],
        remark: "You‚Äôre passing the Padang, a historic playing field that has hosted parades, celebrations and key moments in Singapore‚Äôs history.",
        audioId: "padang"
      },
      {
        name: "Singapore Recreation Club",
        coords: [1.2921, 103.8536],
        remark: "On your right is the Singapore Recreation Club, founded in the 19th century as a social and sports club.",
        audioId: "src"
      },
      {
        name: "Civilian War Memorial",
        coords: [1.2928, 103.8546],
        remark: "On your right, the Civilian War Memorial, honouring civilians who perished during the Second World War.",
        audioId: "civilian_war_memorial"
      },
      {
        name: "Bugis Street",
        coords: [1.3008441018427344, 103.8554553564729],
        remark: "To your right is Bugis Street, once a lively night market and today a popular shopping area.",
        audioId: "bugis_street"
      },
      {
        name: "Elgin Bridge",
        coords: [1.289106349496725, 103.84928087367207],
        remark: "You‚Äôre crossing Elgin Bridge, a historic river crossing linking the civic district with Chinatown.",
        audioId: "elgin_bridge"
      },
      {
        name: "Shophouses on South Bridge Rd",
        coords: [1.2877, 103.8486],
        remark: "Look to your left at the conserved shophouses along South Bridge Road, showing different architectural styles and eras.",
        audioId: "south_bridge_shophouses"
      },
      {
        name: "Hong Lim Park",
        coords: [1.286441677699584, 103.84726628162626],
        remark: "On your right is Hong Lim Park, Singapore‚Äôs designated Speakers‚Äô Corner.",
        audioId: "hong_lim_park"
      },
      {
        name: "Sook Ching Inspection Centre",
        coords: [1.2838687213489226, 103.84602593659656],
        remark: "On your right, this stretch is associated with the Sook Ching inspection centre, linked to a tragic chapter during the Japanese Occupation.",
        audioId: "sook_ching"
      },
      {
        name: "Jamae Chulia Mosque",
        coords: [1.283135410816041, 103.84557499125049],
        remark: "On your right is Jamae Chulia Mosque, serving the Tamil Muslim community since the early 19th century.",
        audioId: "jamae_mosque"
      },
      {
        name: "Sri Mariamman Temple",
        coords: [1.2826974041460475, 103.84521463569506],
        remark: "On your right is Sri Mariamman Temple, the oldest Hindu temple in Singapore, famous for its colourful gopuram, or entrance tower.",
        audioId: "sri_mariamman"
      },
      {
        name: "Buddha Tooth Relic Temple",
        coords: [1.281276211219877, 103.84448897213257],
        remark: "On your right is the Buddha Tooth Relic Temple and Museum, built in a Tang-style inspired architecture.",
        audioId: "buddha_tooth_relic"
      },
      {
        name: "Maxwell Food Centre",
        coords: [1.2803875417995898, 103.84475899768184],
        remark: "On your right is Maxwell Food Centre, a beloved hawker centre where locals queue for chicken rice and many other dishes.",
        audioId: "maxwell_food_centre"
      },
      {
        name: "Urban Redevelopment Authority",
        coords: [1.2798925402672132, 103.84501331341875],
        remark: "On your left is the Urban Redevelopment Authority, responsible for Singapore‚Äôs long-term land use and city planning.",
        audioId: "ura"
      },
      {
        name: "Thian Hock Keng Temple",
        coords: [1.2810248381294773, 103.8476550471662],
        remark: "We have arrived at Thian Hock Keng Temple on Telok Ayer Street, one of Singapore‚Äôs oldest Hokkien temples, dedicated to the sea goddess Mazu.",
        audioId: "thian_hock_keng"
      }
    ];

    // Landmark markers
    landmarks.forEach(lm => {
      L.marker(lm.coords).addTo(map).bindPopup(lm.name);
    });

    // -----------------------------
    // MINI MAP INITIALISATION
    // -----------------------------
    const miniMap = L.map('mini-map', {
      zoomControl: false,
      dragging: false,
      scrollWheelZoom: false,
      doubleClickZoom: false,
      boxZoom: false,
      keyboard: false,
      attributionControl: false
    });

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(miniMap);
    const miniPolyline = L.polyline(route, { color: 'blue', weight: 3 }).addTo(miniMap);
    miniMap.fitBounds(miniPolyline.getBounds());

    // -----------------------------
    // TRAFFIC LIGHTS (real-world-style)
    // -----------------------------
    const trafficLights = [
      {
        name: "Coleman St / Hill St Junction",
        coords: [1.2925, 103.8495],
        cycle: { green: 25, amber: 3, red: 35 },
        offset: 0
      },
      {
        name: "Hill St / Victoria St Junction",
        coords: [1.2946, 103.8506],
        cycle: { green: 28, amber: 3, red: 40 },
        offset: 10
      },
      {
        name: "Victoria St / Middle Rd Junction",
        coords: [1.2984, 103.8542],
        cycle: { green: 22, amber: 3, red: 33 },
        offset: 18
      },
      {
        name: "Middle Rd / North Bridge Rd Junction",
        coords: [1.2974, 103.8548],
        cycle: { green: 24, amber: 3, red: 36 },
        offset: 5
      },
      {
        name: "North Bridge Rd / Elgin Bridge",
        coords: [1.2893, 103.8494],
        cycle: { green: 26, amber: 3, red: 38 },
        offset: 12
      },
      {
        name: "Cross St / Telok Ayer St",
        coords: [1.2821, 103.8484],
        cycle: { green: 20, amber: 3, red: 32 },
        offset: 7
      }
    ];

    let lightTimer = 0;

    function getLightState(light, timer) {
      const total = light.cycle.green + light.cycle.amber + light.cycle.red;
      const t = (timer + (light.offset || 0)) % total;
      if (t < light.cycle.green) return "green";
      if (t < light.cycle.green + light.cycle.amber) return "amber";
      return "red";
    }

    trafficLights.forEach(light => {
      const marker = L.circleMarker(light.coords, {
        radius: 6,
        color: 'red',
        fillColor: 'red',
        fillOpacity: 0.9
      }).addTo(map).bindPopup(light.name);
      light.marker = marker;
      light.state = "red";
    });

    setInterval(() => {
      lightTimer++;
      trafficLights.forEach(light => {
        const state = getLightState(light, lightTimer);
        light.state = state;
        const color =
          state === "green" ? "green" :
          state === "amber" ? "orange" : "red";
        light.marker.setStyle({ color, fillColor: color });
      });
    }, 1000);

    function getTrafficLightNear(position) {
      return trafficLights.find(light =>
        Math.abs(light.coords[0] - position[0]) < 0.0005 &&
        Math.abs(light.coords[1] - position[1]) < 0.0005
      );
    }

    // TIMER
    let routeTimer = 0;        // seconds elapsed
    let timerInterval = null;
    const timerBox = document.getElementById("timer-box");

    function formatTime(sec) {
      const m = Math.floor(sec / 60);
      const s = sec % 60;
      return `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
    }

    function startTimer() {
      if (timerInterval) return; // avoid double-start
      timerInterval = setInterval(() => {
        routeTimer++;
        timerBox.textContent = `‚è± ${formatTime(routeTimer)}`;
      }, 1000);
    }

    function stopTimer() {
      clearInterval(timerInterval);
      timerInterval = null;
    }

    function resetTimer() {
      stopTimer();
      routeTimer = 0;
      timerBox.textContent = "‚è± 00:00";
    }

    // -----------------------------
    // CAR MARKERS (main map + mini map)
    // -----------------------------
    const carIcon = L.icon({
      iconUrl: 'https://cdn-icons-png.flaticon.com/512/854/854894.png',
      iconSize: [35, 35]
    });
    const car = L.marker(route[0], { icon: carIcon }).addTo(map);

    const miniCarIcon = L.icon({
      iconUrl: 'https://cdn-icons-png.flaticon.com/512/854/854894.png',
      iconSize: [20, 20]
    });
    const miniCar = L.marker(route[0], { icon: miniCarIcon }).addTo(miniMap);

    let currentIndex = 0;
    let running = false;
    let moveTimer = null;

    // SPEED CONTROL
    let speedSetting = 2; // 1=Slow, 2=Normal, 3=Fast

    function updateSpeedLabel() {
      if (speedSetting === 1) speedLabel.textContent = "Slow";
      else if (speedSetting === 2) speedLabel.textContent = "Normal";
      else speedLabel.textContent = "Fast";
    }

    function getStepDelay() {
      // Base 60ms, slower when speedSetting is low
      return 60 * (4 - speedSetting); // 1->180ms, 2->120ms, 3->60ms
    }

    speedSlider.addEventListener("input", () => {
      speedSetting = parseInt(speedSlider.value, 10);
      updateSpeedLabel();
    });
    updateSpeedLabel();

    // NARRATION + AUDIO
    function playNarrationFor(landmark) {
      if (!voiceToggle.checked) return;
      if (!landmark.audioId) return;
      const src = `audio/${landmark.audioId}.mp3`; // you place files here
      narrationAudio.src = src;
      narrationAudio.play().catch(() => {
        // Ignore autoplay errors (e.g. browser block)
      });
    }

    function updateNarrationPanel(currentLm, nextLm) {
      if (currentLm) {
        currentNarrationEl.innerHTML =
          `<strong>Current:</strong> ${currentLm.name}`;
      } else {
        currentNarrationEl.innerHTML =
          "<strong>Current:</strong> None yet ‚Äî starting soon.";
      }

      if (nextLm) {
        nextNarrationEl.innerHTML =
          `<strong>Next:</strong> ${nextLm.name}`;
      } else {
        nextNarrationEl.innerHTML =
          "<strong>Next:</strong> End of route.";
      }
    }

    // CHECKPOINT LIST
    function buildCheckpointList() {
      checkpointList.innerHTML = "";
      landmarks.forEach((lm, idx) => {
        const li = document.createElement("li");
        li.id = `checkpoint-${idx}`;
        li.classList.add("checkpoint");
        li.innerHTML = `<span class="checkpoint-icon">‚¨ú</span><span>${lm.name}</span>`;
        checkpointList.appendChild(li);
      });
      // initial "next"
      if (landmarks.length > 0) {
        updateNarrationPanel(null, landmarks[0]);
      }
    }
    buildCheckpointList();

    function markCheckpointDone(landmark) {
      const idx = landmarks.indexOf(landmark);
      if (idx === -1) return;
      const li = document.getElementById(`checkpoint-${idx}`);
      if (!li) return;
      li.classList.add("done");
      const iconSpan = li.querySelector(".checkpoint-icon");
      if (iconSpan) iconSpan.textContent = "‚úî";
    }

    function handleLandmarksAt(position) {
      const nearbyLandmark = landmarks.find(l =>
        !l.shown &&
        Math.abs(l.coords[0] - position[0]) < 0.0008 &&
        Math.abs(l.coords[1] - position[1]) < 0.0008
      );

      if (nearbyLandmark) {
        nearbyLandmark.shown = true;
        remarkBox.innerText = nearbyLandmark.remark;
        playNarrationFor(nearbyLandmark);
        markCheckpointDone(nearbyLandmark);

        const currentIdx = landmarks.indexOf(nearbyLandmark);
        const nextLm = landmarks[currentIdx + 1] || null;
        updateNarrationPanel(nearbyLandmark, nextLm);
      } else {
        remarkBox.innerText = "Moving along the route...";
      }
    }

    // PROGRESS UTILS
    function updateProgress(currentIdx, segmentProgress) {
      const totalSegments = route.length - 1;
      const overall = (currentIdx + segmentProgress) / totalSegments;
      const percent = Math.max(0, Math.min(100, Math.floor(overall * 100)));
      progressBar.style.width = percent + "%";
      progressText.innerText = "Progress: " + percent + "%";
    }

    function clearMoveTimer() {
      if (moveTimer) {
        clearTimeout(moveTimer);
        moveTimer = null;
      }
    }

    // -----------------------------
    // SMOOTH MOVEMENT ENGINE
    // -----------------------------
    function moveCar() {
      if (!running) return;
      if (currentIndex >= route.length - 1) {
        remarkBox.innerText = "üèÅ Route completed!";
        progressBar.style.width = "100%";
        progressText.innerText = "Progress: 100%";
        document.getElementById("startBtn").disabled = false;
        document.getElementById("stopBtn").disabled = true;
        running = false;
        return;
      }

      const from = route[currentIndex];
      const to = route[currentIndex + 1];
      let progress = 0; // 0 ‚Üí 1

      const step = () => {
        if (!running) return;

        const lat = from[0] + (to[0] - from[0]) * progress;
        const lng = from[1] + (to[1] - from[1]) * progress;
        const pos = [lat, lng];

        // Check traffic lights
        const light = getTrafficLightNear(pos);
        if (light && (light.state === "red" || light.state === "amber")) {
          remarkBox.innerText = `üõë Red light at ${light.name}. Please wait...`;
          moveTimer = setTimeout(step, 500);
          return;
        }

        car.setLatLng(pos);
        miniCar.setLatLng(pos);
        updateProgress(currentIndex, progress);

        progress += 0.02;
        if (progress >= 1) {
          currentIndex++;
          const finalPos = route[currentIndex];
          car.setLatLng(finalPos);
          miniCar.setLatLng(finalPos);
          handleLandmarksAt(finalPos);
          moveCar();
        } else {
          moveTimer = setTimeout(step, getStepDelay());
        }
      };

      step();
    }

    // -----------------------------
    // BUTTON LOGIC
    // -----------------------------
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const prevBtn = document.getElementById("prevBtn");
    const resetBtn = document.getElementById("resetBtn");

    startBtn.addEventListener("click", () => {
      
      if (!running) {
        if (currentIndex === 0) {
          landmarks.forEach(l => delete l.shown);
          checkpointList.querySelectorAll(".checkpoint").forEach(li => {
            li.classList.remove("done");
            const iconSpan = li.querySelector(".checkpoint-icon");
            if (iconSpan) iconSpan.textContent = "‚¨ú";
          });
          if (landmarks.length > 0) {
            updateNarrationPanel(null, landmarks[0]);
          }
          remarkBox.innerText = "Starting the route. Look out for key landmarks along the way.";
          updateProgress(0, 0);
        } else {
          remarkBox.innerText = "Resuming the route...";
        }
        running = true;
        startBtn.disabled = true;
        stopBtn.disabled = false;

        startTimer();

        moveCar();
      }
    });

    stopBtn.addEventListener("click", () => {
      running = false;
      clearMoveTimer();
      stopTimer();
      startBtn.disabled = false;
      stopBtn.disabled = true;
      remarkBox.innerText = "‚èπ Route paused.";
    });

    prevBtn.addEventListener("click", () => {
      running = false;
      clearMoveTimer();
      if (currentIndex > 0) {
        currentIndex--;
        const pos = route[currentIndex];
        car.setLatLng(pos);
        miniCar.setLatLng(pos);
        remarkBox.innerText = "Moved to previous point.";
        updateProgress(currentIndex, 0);
      } else {
        remarkBox.innerText = "Already at the start point.";
        updateProgress(0, 0);
      }
      startBtn.disabled = false;
      stopBtn.disabled = true;
    });

    resetBtn.addEventListener("click", () => {
      running = false;
      clearMoveTimer();
      resetTimer();
      currentIndex = 0;
      car.setLatLng(route[0]);
      miniCar.setLatLng(route[0]);
      landmarks.forEach(l => delete l.shown);
      checkpointList.querySelectorAll(".checkpoint").forEach(li => {
        li.classList.remove("done");
        const iconSpan = li.querySelector(".checkpoint-icon");
        if (iconSpan) iconSpan.textContent = "‚¨ú";
      });
      remarkBox.innerText = "Route reset. Press Start to begin again.";
      updateProgress(0, 0);
      if (landmarks.length > 0) {
        updateNarrationPanel(null, landmarks[0]);
      }
      startBtn.disabled = false;
      stopBtn.disabled = true;
    });
  </script>
</body>
</html>
